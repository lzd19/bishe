/*!
 * @form-create/core v2.5.35
 * (c) 2018-2024 xaboy
 * Github https://github.com/xaboy/form-create
 * Released under the MIT License.
 */
import e from"vue";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach(function(t){n(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,r=o(e);if(t){var i=o(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return u(this,n)}}function f(e){return function(e){if(Array.isArray(e))return s(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return s(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function l(t,n,r){e.set(t,n,r)}function d(t,n){e.delete(t,n)}var p=Object.assign||function(e){for(var t,n=1;n<arguments.length;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&l(e,r,t[r]);return e};function h(){return p.apply(this,arguments)}function v(e){return Array.isArray(e)?e:[null,void 0,""].indexOf(e)>-1?[]:[e]}var m="FormCreate",y=function e(t,n){if(t&&t!==n)return t.formCreateInject?t.formCreateInject:t.$parent?e(t.$parent,n):void 0};function g(e){return{name:m,componentName:m,model:{prop:"api"},provide:function(){return{$pfc:this}},inject:{$pfc:{default:null}},props:{rule:{type:Array,required:!0},option:{type:Object,default:function(){return{}}},extendOption:Boolean,disabled:Boolean,value:Object,api:Object,name:String,subForm:{type:Boolean,default:!0},inFor:Boolean},data:function(){return{formData:void 0,destroyed:!1,validate:{},$f:void 0,isShow:!0,unique:1,renderRule:f(this.rule||[]),ctxInject:{},updateValue:JSON.stringify(this.value||{}),isMore:!!this.inFor}},render:function(){return this.formCreate.render()},methods:{_refresh:function(){++this.unique},_renderRule:function(){this.renderRule=f(this.rule||[])},_updateValue:function(e){this.destroyed||(this.updateValue=JSON.stringify(e),this.$emit("update:value",e))}},watch:{value:{handler:function(e){JSON.stringify(e||{})!==this.updateValue&&(this.$f.config.forceCoverValue?this.$f.coverValue(e||{}):this.$f.setValue(e||{}))},deep:!0},option:{handler:function(){this.formCreate.initOptions(),this.$f.refresh()},deep:!0},rule:function(e){var t=this;e.length===this.renderRule.length&&e.every(function(e){return t.renderRule.indexOf(e)>-1})||(this.formCreate.$handle.reloadRule(e),this._renderRule())},disabled:function(e){this.$f.disabled(!!e)}},beforeCreate:function(){var t=this;this.formCreate=new e(this),Object.keys(this.formCreate.prop).forEach(function(e){h(t.$options[e],t.formCreate.prop[e])}),this.$emit("beforeCreate",this.formCreate.api())},created:function(){var e=this,t=this,n=this.formCreate.api(),r=function(){var e=y(t,t.$pfc);if(e)if(t.isMore){var r=v(e.getSubForm()),i=r.indexOf(n);i>-1&&r.splice(i,1)}else e.subForm()};t.$on("hook:beforeDestroy",function(){r()}),this.$watch(function(){return e.subForm},function(e){e?function(){if(t.$pfc){var e,r=y(t,t.$pfc);r&&(t.isMore?(e=v(r.getSubForm())).push(n):e=n,r.subForm(e))}}():r()},{immediate:!0})}}}var _={type:function(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"},Undef:function(e){return null==e},Element:function(e){return"object"===t(e)&&null!==e&&1===e.nodeType&&!_.Object(e)},trueArray:function(e){return Array.isArray(e)&&e.length>0},Function:function(e){var t=this.getType(e);return"Function"===t||"AsyncFunction"===t},getType:function(e){var t=Object.prototype.toString.call(e);return/^\[object (.*)\]$/.exec(t)[1]},empty:function(e){return null==e||(!(!Array.isArray(e)||!Array.isArray(e)||e.length)||"string"==typeof e&&!e)}};function $(e,t){return{}.hasOwnProperty.call(e,t)}["Date","Object","String","Boolean","Array","Number"].forEach(function(e){_[e]=function(t){return _.type(t,e)}});var b=["attrs","props","domProps","scopedSlots"],O=["class","style","directives"],x=["on","nativeOn"],C=function e(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=[].concat(b,f(o.normal||[])),u=[].concat(O,f(o.array||[])),c=[].concat(x,f(o.functional||[])),s=o.props||[];return n.reduce(function(n,r){for(var o in r)if(n[o])if(s.indexOf(o)>-1)n[o]=e([r[o]],n[o]);else if(a.indexOf(o)>-1)n[o]=i(i({},n[o]),r[o]);else if(u.indexOf(o)>-1){var l=n[o]instanceof Array?n[o]:[n[o]],d=r[o]instanceof Array?r[o]:[r[o]];n[o]=[].concat(f(l),f(d))}else if(c.indexOf(o)>-1)for(var p in r[o])if(n[o][p]){var h=n[o][p]instanceof Array?n[o][p]:[n[o][p]],v=r[o][p]instanceof Array?r[o][p]:[r[o][p]];n[o][p]=[].concat(f(h),f(v))}else n[o][p]=r[o][p];else if("hook"===o)for(var m in r[o])n[o][m]?n[o][m]=j(n[o][m],r[o][m]):n[o][m]=r[o][m];else n[o]=r[o];else a.indexOf(o)>-1||c.indexOf(o)>-1||s.indexOf(o)>-1?n[o]=i({},r[o]):u.indexOf(o)>-1?n[o]=r[o]instanceof Array?f(r[o]):"object"===t(r[o])?i({},r[o]):r[o]:n[o]=r[o];return n},r)},j=function(e,t){return function(){e&&e.apply(this,arguments),t&&t.apply(this,arguments)}},E=["type","slot","emitPrefix","value","name","native","hidden","display","inject","options","emit","nativeEmit","link","prefix","suffix","update","sync","optionsTo","key","preview","component","cache"],S=["validate","children","control"],w=["effect","deep"];function F(e,t,n){return"[form-create ".concat(e,"]: ").concat(t)+(n?"\n\nrule: "+JSON.stringify(n.getRule?n.getRule():n):"")}function k(e,t){console.error(F("err",e,t))}function R(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,r=!1;for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)){var o=t[i];if((r=Array.isArray(o))||_.Object(o)){var a=void 0===e[i];if(r)r=!1,a&&l(e,i,[]);else if(o._clone&&void 0!==n){if(!n){l(e,i,o._clone());continue}o=o.getRule(),a&&l(e,i,{})}else a&&l(e,i,{});e[i]=R(e[i],o,n)}else l(e,i,o),_.Undef(o)||(_.Undef(o.__json)||(e[i].__json=o.__json),_.Undef(o.__origin)||(e[i].__origin=o.__origin))}return void 0!==n&&Array.isArray(e)?e.filter(function(e){return!e||!e.__ctrl}):e}function A(e){return R({},{value:e}).value}var V="[[FORM-CREATE-PREFIX-",P="-FORM-CREATE-SUFFIX]]",D="$FN:",T="$FNX:",N="function";function I(e,n){return JSON.stringify(R([],e,!0),function(e,n){if(!n||!0!==n._isVue){if(t(n)!==N)return n;if(n.__json)return n.__json;if(n.__origin&&(n=n.__origin),!n.__emit)return V+n+P}},n)}function L(e){return new Function("return "+e)()}function M(e,t){if(e&&_.String(e)&&e.length>4){var n=e.trim(),r=!1;try{if(n.indexOf(P)>0&&0===n.indexOf(V))n=n.replace(P,"").replace(V,""),r=!0;else if(0===n.indexOf(D))n=n.replace(D,""),r=!0;else{if(0===n.indexOf(T))return(n=L("function($inject){"+n.replace(T,"")+"}")).__json=e,n.__inject=!0,n;t||0!==n.indexOf(N)||n===N||(r=!0)}if(!r)return e;var i=L(-1===n.indexOf(N)&&0!==n.indexOf("(")?N+" "+n:n);return i.__json=e,i}catch(e){return void k("解析失败:".concat(n,"\n\nerr: ").concat(e))}}return e}function q(e,t){return JSON.parse(e,function(e,n){return _.Undef(n)||!n.indexOf?n:M(n,t)})}function U(e,t){return{value:e,enumerable:!1,configurable:!1,writable:!!t}}function J(e){return B([e])[0]}function B(e,t){return R([],f(e),t||!1)}function H(e,t){return C(Array.isArray(t)?t:[t],e,{array:S,normal:w}),e}function W(e){var t=_.Function(e.getRule)?e.getRule():e;return t.type||(t.type="input"),t}function K(e,t){Object.defineProperties(e,Object.keys(t).reduce(function(e,n){return e[n]={get:function(){return t[n]()}},e},{}))}function X(e){return e.__fc__||(e.__origin__?e.__origin__.__fc__:null)}function G(e,t){try{t=e()}catch(e){!function(e){k(e.toString()),console.error(e)}(e)}return t}function Q(e,t){return function(n,r,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=new z(e,n,r,i,o);return t&&(_.Function(t)?t(a):a.props(t)),a}}function z(e,t,n,r,i){this._data=h({props:{},on:{},options:[],children:[],effect:{},hidden:!1,display:!0,value:void 0},{type:e,title:t,field:n,value:r,props:i||{}}),this.event=this.on}function Z(e){e.forEach(function(e){z.prototype[e]=function(t){return H(this._data,n({},e,arguments.length<2?t:n({},t,arguments[1]))),this}})}h(z.prototype,{getRule:function(){return this._data},setProp:function(e,t){return l(this._data,e,t),this},_clone:function(){var e=new this.constructor;return e._data=J(this._data),e}}),Z([].concat(E,f(b),f(O),f(x),S,w));var Y=Q("");function ee(e,t,n){var r=Y("",t);return r._data.type=e,r._data.title=n,r}function te(e,t,n,r){var i=Y("",n);return i._data.type="template",i._data.template=e,i._data.title=r,i._data.vm=t,i}function ne(){return{create:ee,createTmp:te,template:te,factory:Q}}function re(e){return A(e)}function ie(e){return oe(e.replace(/(-[a-z])/g,function(e){return e.replace("-","").toLocaleUpperCase()}))}function oe(e){return e.replace(e[0],e[0].toLowerCase())}function ae(e){var t=e.replace(/([A-Z])/g,"-$1").toLocaleLowerCase();return 0===t.indexOf("-")&&(t=t.substr(1)),t}var ue=0;function ce(){var e=++ue+370;return"F"+Math.random().toString(36).substr(3,3)+Number("".concat(Date.now())).toString(36)+e.toString(36)+"c"}function fe(e,n,r){var i,o=e;return(n||"").split(".").forEach(function(e){i&&(o[i]&&"object"==t(o[i])||(o[i]={}),o=o[i]),i=e}),o[i]=r,o}function se(e){h(this,{$handle:e,fc:e.fc,vm:e.vm,$manager:e.$manager,vNode:new e.fc.CreateNode(e.vm)}),K(this,{options:function(){return e.options},sort:function(){return e.sort}}),this.initCache(),this.initRender()}!function(e){h(e.prototype,{initCache:function(){this.clearCacheAll()},clearCache:function(e){if(!e.rule.cache)if(this.cache[e.id]){(!0===this.cache[e.id].use||this.cache[e.id].parent)&&this.$handle.refresh();var t=this.cache[e.id].parent;this.cache[e.id]=null,t&&this.clearCache(t)}else e.parent&&this.clearCache(e.parent)},clearCacheAll:function(){this.cache={}},setCache:function(e,t,n){this.cache[e.id]={vnode:t,use:!1,parent:n,slot:e.rule.slot}},getCache:function(e){var t=this.cache[e.id];if(t)return t.use=!0,t.vnode}})}(se),function(e){h(e.prototype,{initRender:function(){this.tempList={},this.clearOrgChildren()},initOrgChildren:function(){var e=this.$handle.ctxs;this.orgChildren=Object.keys(e).reduce(function(t,n){if(!1!==e[n].parser.loadChildren){var r=e[n].rule.children;t[n]=_.trueArray(r)?f(r):[]}return t},{})},clearOrgChildren:function(){this.orgChildren={}},getTypeSlot:function(e){return function t(n){if(n){var r=void 0;return e.rule.field&&(r=n.$scopedSlots["field-"+ae(e.rule.field)]||n.$scopedSlots["field-"+e.rule.field]),r||(r=n.$scopedSlots["type-"+ae(e.type)]||n.$scopedSlots["type-"+e.type]),r||t(n.$pfc)}}(this.vm)},render:function(){var e=this;if(this.vm.isShow){var t;this.$h=this.vm.$createElement,this.$manager.beforeRender();var n=function(){return e.renderList()};return n.renderSlot=function(t){return e.renderList(t)},n.renderName=function(t){return e.renderId(t)},n.renderField=function(t){return e.renderId(t,"field")},t=this.vm.$scopedSlots.container?[this.vm.$scopedSlots.container(n)]:n(),this.$manager.render(t)}},renderList:function(e){var t=this;return this.sort.map(function(n){return e?t.renderSlot(t.$handle.ctxs[n],e):t.renderCtx(t.$handle.ctxs[n])}).filter(function(e){return void 0!==e})},makeVm:function(e){var t=this,n=e.vm;return n?_.Function(n)?G(function(){return e.vm(t.$handle.getInjectData(e))}):n._isVue?n:new Re(n):new Re},mergeGlobal:function(e){var t=this.$handle.options.global;t&&(e.cacheConfig||(e.cacheConfig=t[e.originType]||t[e.type]||t[e.trueType]||{}),e.prop=H({},[t["*"],e.cacheConfig,e.prop]))},setOptions:function(e){e.prop.optionsTo&&e.prop.options&&fe(e.prop,e.prop.optionsTo,e.prop.options)},deepSet:function(e){var t=e.rule.deep;t&&Object.keys(t).sort(function(e,t){return e.length<t.length?-1:1}).forEach(function(n){fe(e.prop,n,t[n])})},setTempProps:function(e,t){if(e.$props){var n=t.prop,r=Object.keys(e.$props),i=this.injectProp(t),o=Object.keys(i);r.forEach(function(t){$(n.props,t)?e.$props[t]=n.props[t]:o.indexOf(t)>-1&&(e.$props[t]=i[t])});var a=e.$options.model&&e.$options.model.prop||"value";r.indexOf(a)>-1&&(e.$props[a]=n.value)}},renderTemp:function(e){var t=this;if(!Re.compile)return function(e,t){console.warn(F("tip",e,t))}("当前使用的Vue构建版本不支持compile,无法使用template功能"),[];var n=e.prop,r=e.id,i=e.key;if(!this.tempList[r]){e.el||(e.el=this.makeVm(n),this.vm.$nextTick(function(){return e.parser.mounted(e)}));var o=e.el;e.input&&o.$on(o.$options.model&&o.$options.model.event||"input",function(n){t.onInput(e,n)}),this.tempList[r]={vm:o,template:Re.compile(n.template)}}var a=this.tempList[r],u=a.vm,c=a.template;this.setTempProps(u,e);var f=c.render.call(u);return _.Undef(f.data)&&(f.data={}),f.key=i,f.data.ref=e.ref,f.data.key=i,f},parseSide:function(e,t){return _.Object(e)?H({props:{formCreateInject:t.prop.props.formCreateInject}},e):e},renderSides:function(e,t,n){var r=t[n?"rule":"prop"];return[this.renderRule(this.parseSide(r.prefix,t)),e,this.renderRule(this.parseSide(r.suffix,t))]},renderSlot:function(e,t){return e.rule.slot===t?this.renderCtx(e):void 0},renderId:function(e,t){var n=this,r=this.$handle["field"===t?"fieldCtx":"nameCtx"][e];return r?r.map(function(e){return n.renderCtx(e,e.parent)}):void 0},renderCtx:function(e,t){if("hidden"!==e.type){var n=e.rule;if(!this.cache[e.id]||this.cache[e.id].slot!==n.slot){var r,i=!1!==n.cache,o=e.trueType,a=!(_.Undef(n.display)||n.display);if("template"!==o||n.template)if("fcFragment"===o)r=this.renderChildren(e);else{e.initProp(),this.mergeGlobal(e),this.$manager.tidyRule(e),this.deepSet(e),this.setOptions(e),this.ctxProp(e);var u=e.prop;u.preview=!!($(u,"preview")?u.preview:this.options.preview),u.props.formCreateInject=this.injectProp(e);var c=u.preview;if(u.hidden)return void this.setCache(e,void 0,t);if("template"===o&&u.template)r=this.renderTemp(e),i=!1;else{var f=[];e.parser.renderChildren?f=e.parser.renderChildren(e):!1!==e.parser.loadChildren&&(f=this.renderChildren(e));var s=this.getTypeSlot(e);r=s?s({rule:n,prop:u,preview:c,children:f,api:this.$handle.api,model:u.model||{}}):c?e.parser.preview(f,e):e.parser.render(f,e)}r=this.renderSides(r,e),!e.input&&_.Undef(u.native)||!0===u.native||(r=this.$manager.makeWrap(e,r)),a&&(r=this.display(r)),r=this.item(e,r)}else r=this.renderSides(this.renderChildren(e),e,!0),a&&this.display(r),r=this.item(e,r);return i&&this.setCache(e,r,t),r}return this.getCache(e)}},display:function(e){var t=this;if(Array.isArray(e)){var n=[];return e.forEach(function(e){if(Array.isArray(e))return t.display(e);t.none(e)&&n.push(e)}),n}return this.none(e)},none:function(e){if(e&&e.data)return Array.isArray(e.data.style)?e.data.style.push({display:"none"}):_.String(e.data.style)?e.data.style+=";display:none;":e.data.style=[e.data.style,{display:"none"}],e},item:function(e,t){return this.$h("fcFragment",{slot:e.rule.slot,key:e.key},[t])},injectProp:function(e){var t=this;this.vm.ctxInject[e.id]||l(this.vm.ctxInject,e.id,{api:this.$handle.api,form:this.fc.create,subForm:function(n){t.$handle.addSubForm(e,n)},getSubForm:function(){return t.$handle.subForm[e.id]},options:[],children:[],prop:{},preview:!1,field:e.field,rule:e.rule,input:e.input});var n,r=this.vm.ctxInject[e.id];return h(r,{preview:e.prop.preview,options:e.prop.options,children:e.rule.children,prop:(n=i({},e.prop),n.on=n.on?i({},n.on):{},delete n.model,n)}),r},ctxProp:function(e,t){var n=this,r=e.ref,i=e.key,o=e.rule;this.$manager.mergeProp(e,t),e.parser.mergeProp(e,t);var a=[{ref:r,key:o.key||"".concat(i,"fc"),slot:void 0,on:{"hook:mounted":function(){n.onMounted(e)},"fc.sub-form":function(t){n.$handle.addSubForm(e,t)},"fc.el":function(t){e.exportEl=t,t&&((t.$el||t).__rule__=e.rule)}}}];return!t&&e.input&&(e.prop.model={value:this.$handle.getFormData(e),callback:function(t){n.onInput(e,t)},expression:"formData.".concat(e.id)}),C(a,e.prop),e.prop},onMounted:function(e){e.el=this.vm.$refs[e.ref],e.el&&((e.el.$el||e.el).__rule__=e.rule),e.parser.mounted(e),this.$handle.effect(e,"mounted")},onInput:function(e,t){this.$handle.onInput(e,t)},renderChildren:function(e){var t=this,n=e.rule.children,r=this.orgChildren[e.id],i=function(e){return!_.String(e)&&e.__fc__&&!t.$handle.ctxs[e.__fc__.id]};return!_.trueArray(n)&&r?(this.$handle.deferSyncValue(function(){r.forEach(function(e){e&&i(e)&&t.$handle.rmCtx(e.__fc__)})}),this.orgChildren[e.id]=[],[]):(r&&this.$handle.deferSyncValue(function(){r.forEach(function(e){e&&-1===n.indexOf(e)&&i(e)&&t.$handle.rmCtx(e.__fc__)})}),n.map(function(r){if(r)return _.String(r)?r:r.__fc__?t.renderCtx(r.__fc__,e):void(r.type&&t.vm.$nextTick(function(){t.$handle.loadChildren(n,e),t.$handle.refresh()}))}))},defaultRender:function(e,t){var n=e.prop;return n.component?this.vNode.makeComponent(n.component,n,t):this.vNode[e.type]?this.vNode[e.type](n,t):this.vNode[e.originType]?this.vNode[e.originType](n,t):this.vNode.make(oe(e.originType),n,t)},renderRule:function(e,t,n){var r=this;if(e){if(_.String(e))return e;var o;if(n)o=e.type;else if(o=e.is,e.type){o=ie(e.type);var a=this.vNode.aliasMap[o];a&&(o=ie(a))}if(o){var u=[[t]];return _.trueArray(e.children)&&u.push(e.children.map(function(e){return r.renderRule(e)})),this.$h(o,i({},e),u)}}}})}(se);var le=["hook:updated","hook:mounted"];function de(e,t,n){var r,o=ce();h(this,{id:o,ref:o,wrapRef:o+"fi",rule:t,origin:t.__origin__||t,name:t.name,watch:[],linkOn:[],root:[],ctrlRule:[],parent:null,cacheConfig:null,prop:i({},t),computed:{},payload:{},input:!!t.field,el:void 0,exportEl:void 0,defaultValue:t.field?A(n):void 0,field:t.field||void 0}),this.updateType(),this.updateKey(),r=this,Object.defineProperties(r.origin,{__fc__:U(r,!0)}),this.update(e,!0)}h(de.prototype,{effectData:function(e){return this.payload[e]||(this.payload[e]={}),this.payload[e]},clearEffectData:function(e){void 0===e?this.payload={}:delete this.payload[e]},updateKey:function(e){this.key=ce(),e&&this.parent&&this.parent.updateKey(e)},updateType:function(){this.originType=this.rule.type,this.type=ie(this.rule.type)},setParser:function(e){this.parser=e,e.init(this)},initProp:function(){var e=this,t=i({},this.rule);delete t.children,this.prop=H({},[t].concat(f(Object.keys(this.payload).map(function(t){return e.payload[t]})),[this.computed]))},check:function(e){return this.vm===e.vm},unwatch:function(){this.watch.forEach(function(e){return e()}),this.watch=[]},unlink:function(){this.linkOn.forEach(function(e){return e()}),this.linkOn=[]},link:function(){this.unlink(),this.$handle.appendLink(this)},watchTo:function(){this.$handle.watchCtx(this)},delete:function(){this.unwatch(),this.unlink(),this.rmCtrl(),h(this,{deleted:!0,prop:i({},this.rule),computed:{},el:void 0,$handle:void 0,$render:void 0,$api:void 0,vm:void 0,vNode:void 0,parent:null,cacheConfig:null})},rmCtrl:function(){this.ctrlRule.forEach(function(e){return e.__fc__&&e.__fc__.rm()}),this.ctrlRule=[]},rm:function(){var e=this,t=function(){var t=e.root.indexOf(e.origin);t>-1&&(e.root.splice(t,1),e.$handle&&e.$handle.refresh())};this.deleted?t():this.$handle.noWatch(function(){e.$handle.deferSyncValue(function(){e.rmCtrl(),t(),e.$handle.rmCtx(e),h(e,{root:[]})},e.input)})},update:function(e,t){h(this,{deleted:!1,$handle:e,$render:e.$render,$api:e.api,vm:e.vm,trueType:e.getType(this.originType),vNode:e.$render.vNode,updated:!1,cacheValue:this.rule.value}),!t&&this.unwatch(),this.watchTo(),this.link()}});var pe={"==":function(e){return function(t){return t===e}},"!=":function(e){return function(t){return t!==e}},"<>":function(e){return function(t){return t!==e}},">":function(e){return function(t){return t>e}},">=":function(e){return function(t){return t>=e}},"<":function(e){return function(t){return t<e}},"<=":function(e){return function(t){return t<=e}},in:function(e){return function(t){return e&&e.indexOf&&e.indexOf(t)>-1}},on:function(e){return function(t){return t&&t.indexOf&&t.indexOf(e)>-1}},notIn:function(e){return function(t){return!pe.in(e)(t)}},notOn:function(e){return function(t){return!pe.on(e)(t)}},between:function(e){return function(t){return t>e[0]&&t<e[1]}},notBetween:function(e){return function(t){return t<e[0]||t>e[1]}}};function he(e,t){for(var n=0;n<e.ctrlRule.length;n++){var r=e.ctrlRule[n];if(r.children===t)return r}}function ve(e){return!!e.rule.__ctrl}function me(e,t){return"function"==typeof t?""+t:t}function ye(e){Object.keys(e).forEach(function(t){return delete e[t]})}var ge={init:function(e){},toFormValue:function(e,t){return e},toValue:function(e,t){return e},mounted:function(e){},render:function(e,t){return t.$render.defaultRender(t,e)},preview:function(e,t){return this.render(e,t)},mergeProp:function(e){}},_e=["field","value","vm","template","name","config","control","inject","sync","payload","optionsTo","update","component","cache"];function $e(e){var t=this;h(this,{fc:e,vm:e.vm,watching:!1,loading:!1,reloading:!1,noWatchFn:null,deferSyncFn:null,isMounted:!1,formData:{},subForm:{},form:{},appendData:{},providers:{},cycleLoad:null,loadedId:1,nextTick:null,changeStatus:!1,pageEnd:!0,nextReload:function(){t.lifecycle("reload")}}),K(this,{options:function(){return e.options},bus:function(){return e.bus}}),this.initData(e.rules),this.$manager=new e.manager(this),this.$render=new se(this),this.api=e.extendApi(function(e){function t(t){return _.Undef(t)?t=e.fields():Array.isArray(t)||(t=[t]),t}function r(n,r,i){t(n).forEach(function(t){e.getCtxs(t).forEach(function(t){l(t.rule,r,i),e.$render.clearCache(t)})})}function o(){var t=e.subForm;return Object.keys(t).reduce(function(e,n){var r=t[n];return r?(Array.isArray(r)?e.push.apply(e,f(r)):e.push(r),e):e},[])}var a={get config(){return e.options},get options(){return e.options},get form(){return e.form},get rule(){return e.rules},get parent(){return e.vm.$pfc&&e.vm.$pfc.$f},get top(){return a.parent?a.parent.top:a},get children(){return o()},formData:function(n){return t(n).reduce(function(t,n){var r=e.getFieldCtx(n);return r?(t[r.field]=re(r.rule.value),t):t},e.options.appendValue?re(e.appendData):{})},getValue:function(t){var n=e.getFieldCtx(t);if(n)return re(n.rule.value)},coverValue:function(t){var n=i({},t||{});e.deferSyncValue(function(){a.fields().forEach(function(t){var r=e.fieldCtx[t];if(r){var i=$(n,t);r.forEach(function(e){e.rule.value=i?n[t]:void 0}),delete n[t]}}),h(e.appendData,n)})},setValue:function(t){var r=t;arguments.length>=2&&(r=n({},t,arguments[1])),e.deferSyncValue(function(){Object.keys(r).forEach(function(t){var n=e.fieldCtx[t];if(!n)return e.appendData[t]=r[t];n.forEach(function(e){e.rule.value=r[t]})})})},removeField:function(t){var n=e.getCtx(t);return e.deferSyncValue(function(){e.getCtxs(t).forEach(function(e){e.rm()})},!0),n?n.origin:void 0},removeRule:function(e){var t=e&&X(e);if(t)return t.rm(),t.origin},destroy:function(){e.vm.$el.parentNode&&e.vm.$el.parentNode.removeChild(e.vm.$el),e.vm.$destroy()},fields:function(){return e.fields()},append:function(t,n,r){var i,o=e.sort.length-1,a=e.getCtx(n);a?r?(i=a.rule.children,o=a.rule.children.length-1):(o=a.root.indexOf(a.origin),i=a.root):i=e.rules,i.splice(o+1,0,t)},prepend:function(t,n,r){var i,o=0,a=e.getCtx(n);a?r?i=a.rule.children:(o=a.root.indexOf(a.origin),i=a.root):i=e.rules,i.splice(o,0,t)},hidden:function(t,n){r(n,"hidden",!!t),e.refresh()},hiddenStatus:function(t){var n=e.getCtx(t);if(n)return!!n.rule.hidden},display:function(t,n){r(n,"display",!!t),e.refresh()},displayStatus:function(t){var n=e.getCtx(t);if(n)return!!n.rule.display},disabled:function(n,r){t(r).forEach(function(t){e.getCtxs(t).forEach(function(e){e.rule.props&&l(e.rule.props,"disabled",!!n)})}),e.refresh()},all:function(t){return Object.keys(e.ctxs).map(function(n){var r=e.ctxs[n];return t?r.origin:r.rule})},model:function(t){return e.fields().reduce(function(n,r){var i=e.fieldCtx[r][0];return n[r]=t?i.origin:i.rule,n},{})},component:function(t){return Object.keys(e.nameCtx).reduce(function(n,r){var i=e.nameCtx[r].map(function(e){return t?e.origin:e.rule});return n[r]=1===i.length?i[0]:i,n},{})},bind:function(){return a.form},reload:function(t){e.reloadRule(t)},updateOptions:function(t){e.fc.updateOptions(t),a.refresh()},onSubmit:function(e){a.updateOptions({onSubmit:e})},sync:function(t){if(Array.isArray(t))t.forEach(function(e){return a.sync(e)});else{var n=_.Object(t)?X(t):e.getCtxs(t);n&&((n=Array.isArray(n)?n:[n]).forEach(function(t){if(!t.deleted){var n=e.subForm[t.id];n&&(Array.isArray(n)?n.forEach(function(e){e.refresh()}):n&&n.refresh()),e.$render.clearCache(t)}}),e.refresh())}},refresh:function(){o().forEach(function(e){e.refresh()}),e.$render.clearCacheAll(),e.refresh()},refreshOptions:function(){e.$manager.updateOptions(e.options),a.refresh()},hideForm:function(t){l(e.vm,"isShow",!t)},changeStatus:function(){return e.changeStatus},clearChangeStatus:function(){e.changeStatus=!1},updateRule:function(t,n){e.getCtxs(t).forEach(function(e){h(e.rule,n)})},updateRules:function(e){Object.keys(e).forEach(function(t){a.updateRule(t,e[t])})},mergeRule:function(t,n){e.getCtxs(t).forEach(function(e){H(e.rule,n)})},mergeRules:function(e){Object.keys(e).forEach(function(t){a.mergeRule(t,e[t])})},getRule:function(t,n){var r=e.getCtx(t);if(r)return n?r.origin:r.rule},setEffect:function(t,n,r){var i=e.getCtx(t);i&&n&&("$"===n[0]&&(n=n.substr(1)),$(i.rule,"$"+n)&&l(i.rule,"$"+n,r),$(i.rule,"effect")||l(i.rule,"effect",{}),l(i.rule.effect,n,r))},clearEffectData:function(t,n){var r=e.getCtx(t);r&&(n&&"$"===n[0]&&(n=n.substr(1)),r.clearEffectData(n),a.sync(t))},updateValidate:function(e,t,n){n?a.mergeRule(e,{validate:t}):r(e,"validate",t)},updateValidates:function(e,t){Object.keys(e).forEach(function(n){a.updateValidate(n,e[n],t)})},refreshValidate:function(){e.vm.validate={},a.refresh()},resetFields:function(n){t(n).forEach(function(t){e.getCtxs(t).forEach(function(t){e.$render.clearCache(t),t.rule.value=re(t.defaultValue)})})},method:function(e,t){var n=a.el(e);if(!n||!n[t])throw new Error(F("err","".concat(t,"方法不存在")));return function(){return n[t].apply(n,arguments)}},exec:function(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return G(function(){return a.method(e,t).apply(void 0,r)})},toJson:function(e){return I(a.rule,e)},trigger:function(e,t){for(var n=a.el(e),r=arguments.length,i=new Array(r>2?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];n&&n.$emit.apply(n,[t].concat(i))},el:function(t){var n=e.getCtx(t);if(n)return n.exportEl||n.el||e.vm.$refs[n.ref]},closeModal:function(e){var t=a.el(e);t&&t.$emit&&t.$emit("close-modal")},getSubForm:function(t){var n=e.getCtx(t);return n?e.subForm[n.id]:void 0},nextTick:function(t){e.bus.$once("next-tick",t),e.refresh()},nextRefresh:function(t){e.nextRefresh(),t&&G(t)},emit:function(t){for(var n,r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];(n=e.vm).$emit.apply(n,[t].concat(i))},deferSyncValue:function(t,n){e.deferSyncValue(t,n)},helper:{tidyFields:t,props:r}};return["on","once","off","set"].forEach(function(t){a[t]=function(){var n;(n=e.vm)["$".concat(t)].apply(n,arguments)}}),a.changeValue=a.changeField=a.setValue,a}(this),this)}function be(e){var t=e.responseText||e.response;if(!t)return t;try{return JSON.parse(t)}catch(e){return t}}function Oe(e){if("undefined"!=typeof XMLHttpRequest){var t,n=new XMLHttpRequest,r=e.action;n.onerror=function(t){e.onError(t)},n.onload=function(){if(n.status<200||n.status>=300)return e.onError(function(e,t,n){var r="fail to ".concat(e," ").concat(n.status,"'"),i=new Error(r);return i.status=n.status,i.url=e,i}(r,0,n),be(n));e.onSuccess(be(n))},n.open(e.method||"get",r,!0),e.data&&("json"!==(e.dataType||"").toLowerCase()?(t=new FormData,Object.keys(e.data).map(function(n){t.append(n,e.data[n])})):(t=JSON.stringify(e.data),n.setRequestHeader("content-type","application/json"))),e.withCredentials&&"withCredentials"in n&&(n.withCredentials=!0);var i=e.headers||{};Object.keys(i).forEach(function(e){null!==i[e]&&n.setRequestHeader(e,i[e])}),n.send(t)}}h($e.prototype,{initData:function(e){h(this,{ctxs:{},fieldCtx:{},nameCtx:{},sort:[],rules:e})},init:function(){this.appendData=i(i(i({},this.fc.options.formData||{}),this.vm.value||{}),this.appendData),this.useProvider(),this.usePage(),this.loadRule(),this.$manager.__init(),this.vm.$set(this.vm,"formData",this.formData)}}),function(e){h(e.prototype,{parseInjectEvent:function(e,t){var n=e.inject||this.options.injectEvent;return this.parseEventLst(e,t,n)},parseEventLst:function(e,t,n,r){var i=this;return Object.keys(t).forEach(function(o){var a=i.parseEvent(e,t[o],n,r);a&&(t[o]=a)}),t},parseEvent:function(e,t,n,r){if(_.Function(t)&&(!1!==n&&!_.Undef(n)||t.__inject))return this.inject(e,t,n);if(!r&&Array.isArray(t)&&t[0]&&(_.String(t[0])||_.Function(t[0])))return this.parseEventLst(e,t,n,!0);if(_.String(t)){var i=M(t);if(i&&t!==i)return i.__inject?this.parseEvent(e,i,n,!0):i}},parseEmit:function(e,t){var n=this,r={},i=e.rule,o=i.emitPrefix,a=i.field,u=i.name,c=i.inject,f=i[t?"emit":"nativeEmit"]||[];if(_.trueArray(f)){var s=o||a||u;s&&(t||(s="native-".concat(s)),f.forEach(function(e){if(e){var t;_.Object(e)&&(t=e.inject,e=e.name);var o=ae("".concat(s,"-").concat(e)),a=function(){for(var e,t,r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];(e=n.vm).$emit.apply(e,[o].concat(i)),(t=n.vm).$emit.apply(t,["emit-event",o].concat(i))};if(a.__emit=!0,t||!1!==c){var u=t||c||n.options.injectEvent;r[e]=_.Undef(u)?a:n.inject(i,a,u)}else r[e]=a}}))}return e.computed[t?"on":"nativeOn"]=r,r},getInjectData:function(e,t){var n=this.vm.$options.propsData,r=n.option,i=n.rule;return{api:this.api,$f:this.api,rule:i,self:e.__origin__,option:r,inject:t}},inject:function(e,t,n){if(t.__origin){if(this.watching&&!this.loading)return t;t=t.__origin}var r=this,i=function(){for(var i=r.getInjectData(e,n),o=arguments.length,a=new Array(o),u=0;u<o;u++)a[u]=arguments[u];return i.args=[].concat(a),a.unshift(i),t.apply(this,a)};return i.__origin=t,i.__json=t.__json,i}})}($e),function(e){h(e.prototype,{usePage:function(){var e=this,t=this.options.page;if(t){var n,r=25,i=(n=this.rules).length<31?31:Math.ceil(n.length/3);_.Object(t)&&(t.first&&(r=parseInt(t.first,10)||r),t.limit&&(i=parseInt(t.limit,10)||i)),h(this,{first:r,limit:i,pageEnd:this.rules.length<=r}),this.bus.$on("page-end",function(){return e.vm.$emit("page-end",e.api)}),this.pageLoad()}},pageLoad:function(){var e=this;this.vm.$on(le,function t(){e.pageEnd?(e.vm.$off(le,t),e.bus.$emit("page-end")):(e.first+=e.limit,e.pageEnd=e.rules.length<=e.first,e.loadRule(),e.refresh())})}})}($e),function(e){h(e.prototype,{clearNextTick:function(){this.nextTick&&clearTimeout(this.nextTick),this.nextTick=null},bindNextTick:function(e){var t=this;this.clearNextTick(),this.nextTick=setTimeout(function(){e(),t.nextTick=null},10)},render:function(){return++this.loadedId,this.vm.unique>0?this.$render.render():(this.vm.unique=1,[])}})}($e),function(e){h(e.prototype,{nextRefresh:function(e){var t=this,n=this.loadedId;this.vm.$nextTick(function(){n===t.loadedId&&(e?e():t.refresh())})},parseRule:function(e){var t=this,n=W(e);return Object.defineProperties(n,{__origin__:U(e,!0)}),function(e){var t={props:{},on:{},options:[],children:[],effect:{},hidden:!1,display:!0,value:void 0};Object.keys(t).forEach(function(n){$(e,n)||l(e,n,t[n])})}(n),this.appendValue(n),n.options=Array.isArray(n.options)?n.options:[],[n,n.prefix,n.suffix].forEach(function(e){e&&t.loadFn(e,n)}),this.loadCtrl(n),n.update&&(n.update=M(n.update)),n},loadFn:function(e,t){var n=this;["on","props","nativeOn","deep"].forEach(function(r){e[r]&&n.parseInjectEvent(t,e[r])})},loadCtrl:function(e){e.control&&e.control.forEach(function(e){e.handle&&(e.handle=M(e.handle))})},syncProp:function(e){var t=this,n=e.rule;_.trueArray(n.sync)&&C([{on:n.sync.reduce(function(e,r){return e["update:".concat(r)]=function(e){n.props[r]=e,t.vm.$emit("sync",r,e,n,t.fapi)},e},{})}],e.computed)},loadRule:function(){var e=this;this.cycleLoad=!1,this.loading=!0,this.pageEnd&&this.bus.$emit("load-start"),this.deferSyncValue(function(){if(e._loadRule(e.rules),e.loading=!1,e.cycleLoad&&e.pageEnd)return e.loadRule();e.pageEnd&&e.bus.$emit("load-end"),e.vm._renderRule(),e.$render.initOrgChildren(),e.syncForm()})},loadChildren:function(e,t){if(this.cycleLoad=!1,this.loading=!0,this.bus.$emit("load-start"),this._loadRule(e,t),this.loading=!1,this.cycleLoad)return this.loadRule();this.bus.$emit("load-end"),this.syncForm(),this.$render.clearCache(t)},_loadRule:function(e,t){var n=this,r=function(e,t){_.trueArray(e)&&n._loadRule(e,t)};e.map(function(i,o){if((!t||_.Object(i))&&(n.pageEnd||t||!(o>=n.first))){if(i.__fc__&&i.__fc__.root===e&&n.ctxs[i.__fc__.id])return r(i.__fc__.rule.children,i.__fc__),i.__fc__;var a,u=W(i),c=function(){return!(!u.field||!n.fieldCtx[u.field]||n.fieldCtx[u.field][0]===i.__fc__)};n.ruleEffect(u,"init",{repeat:c()}),c()&&n.vm.$emit("repeat-field",i,n.api);var f=!1,s=!!i.__fc__,l=u.value;if(s){l=(a=i.__fc__).defaultValue;var d=!a.check(n);if(a.deleted){if(d){if(ve(a))return;a.update(n)}}else if(d){if(ve(a))return;e[o]=i=i._clone?i._clone():J(i),a=null,f=!0}}if(a)a.originType!==a.rule.type&&(a.updateType(),n.bindParser(a)),n.appendValue(a.rule);else{var p=n.parseRule(i);a=new de(n,p,s?l:p.value),n.bindParser(a)}if([!1,!0].forEach(function(e){return n.parseEmit(a,e)}),n.syncProp(a),a.parent=t||null,a.root=e,n.setCtx(a),!f&&!s&&n.effect(a,"load"),n.effect(a,"created"),!1===a.parser.loadChildren||r(a.rule.children,a),!t){var h=function t(r){var i=e[r-1];if(!i||!i.__fc__)return r>0?t(r-1):-1;var o=n.sort.indexOf(i.__fc__.id);return o>-1?o:t(r-1)}(o);h>-1||!o?n.sort.splice(h+1,0,a.id):n.sort.push(a.id)}var v=a.rule;return a.updated||(a.updated=!0,_.Function(v.update)&&n.bus.$once("load-end",function(){n.refreshUpdate(a,v.value,"init")}),n.effect(a,"loaded")),a.input&&Object.defineProperty(v,"value",n.valueHandle(a)),n.refreshControl(a)&&(n.cycleLoad=!0),a}})},refreshControl:function(e){return e.input&&e.rule.control&&this.useCtrl(e)},useCtrl:function(e){var t=this,n=function(e){var t=e.rule.control||[];return _.Object(t)?[t]:t}(e),r=[],o=this.api;if(!n.length)return!1;for(var a=function(t){var a=n[t],u=a.handle||(pe[a.condition||"=="]||pe["=="])(a.value);if(!_.trueArray(a.rule))return"continue";var c=i(i({},a),{},{valid:G(function(){return u(e.rule.value,o)}),ctrl:he(e,a.rule),isHidden:_.String(a.rule[0])});if(c.valid&&c.ctrl||!c.valid&&!c.ctrl&&!c.isHidden)return"continue";r.push(c)},u=0;u<n.length;u++)a(u);if(!r.length)return!1;var c=[],f=!1;return this.deferSyncValue(function(){r.reverse().forEach(function(n){var r=n.isHidden,i=n.valid,a=n.rule,u=n.prepend,s=n.append,l=n.child,d=n.ctrl,p=n.method;if(r)return i?e.ctrlRule.push({__ctrl:!0,children:a,valid:i}):e.ctrlRule.splice(e.ctrlRule.indexOf(d),1),void c[i?"push":"unshift"](function(){"disabled"===p?t.api.disabled(!i,a):"display"===p?t.api.display(i,a):"required"===p?(a.forEach(function(e){t.api.setEffect(e,"required",i)}),i||t.api.clearValidateState(a)):t.api.hidden(!i,a)});if(i){f=!0;var h={type:"fcFragment",native:!0,__ctrl:!0,children:a};e.ctrlRule.push(h),t.bus.$once("load-start",function(){u?o.prepend(h,u,l):s||l?o.append(h,s||e.id,l):e.root.splice(e.root.indexOf(e.origin)+1,0,h)})}else{e.ctrlRule.splice(e.ctrlRule.indexOf(d),1);var v=X(d);v&&v.rm()}})}),c.length&&this.vm.$nextTick(function(){c.forEach(function(e){return e()})}),this.vm.$emit("control",e.origin,this.api),this.effect(e,"control"),f},reloadRule:function(e){return this._reloadRule(e)},_reloadRule:function(e){var t=this;e||(e=this.rules);var n=i({},this.ctxs);this.clearNextTick(),this.$render.clearOrgChildren(),this.initData(e),this.fc.rules=e,this.deferSyncValue(function(){t.bus.$once("load-end",function(){Object.keys(n).filter(function(e){return void 0===t.ctxs[e]}).forEach(function(e){return t.rmCtx(n[e])}),t.$render.clearCacheAll()}),t.reloading=!0,t.loadRule(),t.reloading=!1,t.refresh(),t.vm.$emit("reloading",t.api)}),this.bus.$off("next-tick",this.nextReload),this.bus.$once("next-tick",this.nextReload),this.vm.$emit("update",this.api)},refresh:function(){this.vm._refresh()}})}($e),function(e){h(e.prototype,{getValue:function(e){return _.Undef(e.cacheValue)&&(e.cacheValue=e.parser.toValue(this.getFormData(e),e)),e.cacheValue},setValue:function(e,t,n,r){e.deleted||(e.cacheValue=t,this.changeStatus=!0,this.nextRefresh(),this.$render.clearCache(e),this.setFormData(e,n),this.syncValue(),this.valueChange(e,t),this.vm.$emit("change",e.field,t,e.origin,this.api,r||!1),this.effect(e,"value"))},onInput:function(e,t){var n;e.input&&(this.isQuote(e,n=e.parser.toValue(t,e))||this.isChange(e,n))&&this.setValue(e,n,t)},setFormData:function(e,t){l(this.formData,e.id,null===t?void 0:t)},getFormData:function(e){return this.formData[e.id]},validate:function(){var e=this;return ye(this.vm.validate),this.fields().forEach(function(t){e.fieldCtx[t].forEach(function(t){e.vm.validate[t.id]=v(t.rule.validate)})}),this.vm.validate},syncForm:function(){var e=this;ye(this.form),Object.defineProperties(this.form,this.fields().reduce(function(t,n){var r=e.getFieldCtx(n),i=e.valueHandle(r);return i.configurable=!0,t[n]=i,t},this.options.appendValue?Object.keys(this.appendData).reduce(function(t,n){return t[n]={enumerable:!0,configurable:!0,get:function(){return e.appendData[n]},set:function(t){e.appendData[n]=t}},t},{}):{})),this.syncValue()},valueHandle:function(e){var t=this;return{enumerable:!0,get:function(){return t.getValue(e)},set:function(n){t.isChange(e,n)&&t.setValue(e,n,e.parser.toFormValue(n,e),!0)}}},appendValue:function(e){e.field&&$(this.appendData,e.field)&&(e.value=this.appendData[e.field],delete this.appendData[e.field])},addSubForm:function(e,t){this.subForm[e.id]=t},deferSyncValue:function(e,t){this.deferSyncFn||(this.deferSyncFn=e),this.deferSyncFn.sync||(this.deferSyncFn.sync=t),G(e),this.deferSyncFn===e&&(this.deferSyncFn=null,e.sync&&this.syncValue())},syncValue:function(){if(this.deferSyncFn)return this.deferSyncFn.sync=!0;this.vm._updateValue(i(i({},this.options.appendValue?this.appendData:{}),this.form))},isChange:function(e,t){return JSON.stringify(e.rule.value,me)!==JSON.stringify(null===t?void 0:t,me)},isQuote:function(e,t){return(_.Object(t)||Array.isArray(t))&&t===e.rule.value},refreshUpdate:function(e,t,n){var r=this;if(_.Function(e.rule.update)){var i=G(function(){return e.rule.update(t,e.origin,r.api,{origin:n||"change"})});if(void 0===i)return;e.rule.hidden=!0===i}},valueChange:function(e,t){this.refreshRule(e,t),this.bus.$emit("change-"+e.field,t)},refreshRule:function(e,t,n){this.refreshControl(e)&&(this.$render.clearCacheAll(),this.loadRule(),this.vm.$emit("update",this.api),this.refresh()),this.refreshUpdate(e,t,n)},appendLink:function(e){var t=this,n=e.rule.link;_.trueArray(n)&&n.forEach(function(n){var r=function(){return t.refreshRule(e,e.rule.value,"link")};t.bus.$on("change-"+n,r),e.linkOn.push(function(){return t.bus.$off("change-"+n,r)})})},fields:function(){return Object.keys(this.fieldCtx)}})}($e),function(e){h(e.prototype,{getCtx:function(e){return this.getFieldCtx(e)||this.getNameCtx(e)[0]||this.ctxs[e]},getCtxs:function(e){return this.fieldCtx[e]||this.nameCtx[e]||(this.ctxs[e]?[this.ctxs[e]]:[])},setIdCtx:function(e,t,n){var r="".concat(n,"Ctx");this[r][t]?this[r][t].push(e):this[r][t]=[e]},rmIdCtx:function(e,t,n){var r="".concat(n,"Ctx"),i=this[r][t];if(!i)return!1;var o=i.splice(i.indexOf(e)>>>0,1).length>0;return i.length||delete this[r][t],o},getFieldCtx:function(e){return(this.fieldCtx[e]||[])[0]},getNameCtx:function(e){return this.nameCtx[e]||[]},setCtx:function(e){var t=e.id,n=e.field,r=e.name,i=e.rule;this.ctxs[t]=e,r&&this.setIdCtx(e,r,"name"),e.input&&(this.setIdCtx(e,n,"field"),this.setFormData(e,e.parser.toFormValue(i.value,e)),this.isMounted&&!this.reloading&&this.vm.$emit("change",e.field,i.value,e.origin,this.api))},getParser:function(e){var t=this.fc.parsers;return t[e.originType]||t[ie(e.type)]||t[e.trueType]||ge},bindParser:function(e){e.setParser(this.getParser(e))},getType:function(e){var t=this.fc.CreateNode.aliasMap,n=t[e]||t[ie(e)]||e;return ie(n)},noWatch:function(e){this.noWatchFn||(this.noWatchFn=e),G(e),this.noWatchFn===e&&(this.noWatchFn=null)},watchCtx:function(e){var t=this,n=this.vm;Object.keys(e.rule).filter(function(e){return"_"!==e[0]&&"$"!==e[0]&&-1===_e.indexOf(e)}).forEach(function(r){var i="children"===r;e.watch.push(n.$watch(function(){return e.rule[r]},function(n,o){if(!(t.loading||t.noWatchFn||t.reloading)){if(i&&!1===e.parser.loadChildren)return t.$render.clearCache(e),void t.nextRefresh();if(t.watching=!0,"link"!==r){if(["props","on","nativeOn","deep"].indexOf(r)>-1)t.parseInjectEvent(e.rule,n||{}),"props"===r&&e.input&&t.setFormData(e,e.parser.toFormValue(e.rule.value,e));else if(["emit","nativeEmit"].indexOf(r)>-1)t.parseEmit(e,"emit"===r);else if(["prefix","suffix"].indexOf(r)>-1)n&&t.loadFn(n,e.rule);else if("type"===r)e.updateType(),t.bindParser(e);else if("children"===r){var a=_.trueArray(n);t.deferSyncValue(function(){n!==o&&(t.rmSub(o,e),t.$render.initOrgChildren()),a&&t.loadChildren(n,e),t.vm.$emit("update",t.api)})}t.$render.clearCache(e),t.refresh(),t.watching=!1}else e.link()}},{deep:!i,sync:i}))}),this.watchEffect(e)},rmSub:function(e,t){var n=this;_.trueArray(e)&&e.forEach(function(e){e&&e.__fc__&&e.__fc__.parent===t&&n.rmCtx(e.__fc__)})},rmCtx:function(e){var t=this;if(!e.deleted){var n=e.id,r=e.field,i=e.input,o=e.name;e.input&&Object.defineProperty(e.rule,"value",{value:e.rule.value,writable:!0}),d(this.ctxs,n),d(this.$render.tempList,n),d(this.$render.orgChildren,n),d(this.vm.ctxInject,n),d(this.formData,n),d(this.subForm,n),d(e,"cacheValue"),i&&this.rmIdCtx(e,r,"field"),o&&this.rmIdCtx(e,o,"name"),i&&!$(this.fieldCtx,r)&&d(this.form,r),this.deferSyncValue(function(){t.reloading||(!1!==e.parser.loadChildren&&_.trueArray(e.rule.children)&&e.rule.children.forEach(function(e){return e.__fc__&&t.rmCtx(e.__fc__)}),e.root===t.rules&&t.vm._renderRule())},i);var a=this.sort.indexOf(n);return a>-1&&this.sort.splice(a,1),this.$render.clearCache(e),e.delete(),this.effect(e,"deleted"),i&&!this.fieldCtx[r]&&this.vm.$emit("removeField",r,e.rule,this.api),e.rule.__ctrl||this.vm.$emit("removeRule",e.rule,this.api),e}}})}($e),function(e){h(e.prototype,{mounted:function(){var e=this,t=function(){e.isMounted=!0,e.lifecycle("mounted")};this.pageEnd?t():this.bus.$once("page-end",t)},lifecycle:function(e){var t=this,n=this.options[e];_.Function(n)&&G(function(){return n(t.api)}),this.vm.$emit(e,this.api)}})}($e),function(e){h(e.prototype,{useProvider:function(){var e=this,t=this.fc.providers;Object.keys(t).forEach(function(n){var r=t[n];_.Function(r)&&(r=r(e.fc)),r._c=function(e){var t=e.components;if(Array.isArray(t)){var n=function(e){return e.filter(function(e,t,n){return n.indexOf(e,0)===t})}(t.filter(function(e){return"*"!==e}));return!!n.length&&n}return!!_.String(t)&&[t]}(r),e.onEffect(r),e.providers[n]=r})},onEffect:function(e){var t=this,n=[];(e._c||["*"]).forEach(function(r){var i="*"===r?"*":t.getType(r);n.indexOf(i)>-1||(n.push(i),t.bus.$on("p:".concat(e.name,":").concat(i,":").concat(e.input?1:0),function(t,n){e[t]&&e[t].apply(e,f(n))}))}),e._used=n},watchEffect:function(e){var t=this,r=this.vm,i={required:function(){var t,n;return($(e.rule,"$required")?e.rule.$required:null===(t=e.rule)||void 0===t?void 0:null===(n=t.effect)||void 0===n?void 0:n.required)||!1}};Object.keys(e.rule.effect||{}).forEach(function(t){i[t]=function(){return e.rule.effect[t]}}),Object.keys(e.rule).forEach(function(t){"$"===t[0]&&(i[t.substr(1)]=function(){return e.rule[t]})}),Object.keys(i||{}).forEach(function(o){e.watch.push(r.$watch(i[o],function(r){t.effect(e,"watch",n({},o,r))},{deep:!0}))})},ruleEffect:function(e,t,n){this.emitEffect({rule:e,input:!!e.field,type:this.getType(e.type)},t,n)},effect:function(e,t,n){this.emitEffect({rule:e.rule,input:e.input,type:e.trueType,ctx:e,custom:n},t)},getEffect:function(e,t){return $(e,"$"+t)?e["$"+t]:$(e,"effect")&&$(e.effect,t)?e.effect[t]:void 0},emitEffect:function(e,t,n){var r=this,o=e.ctx,a=e.rule,u=e.input,c=e.type,f=e.custom;if(c&&"fcFragment"!==c){var s=f||Object.keys(a).reduce(function(e,t){return"$"===t[0]&&(e[t.substr(1)]=a[t]),e},i({},a.effect||{}));Object.keys(s).forEach(function(e){var f=r.providers[e];if(f&&(!f.input||u)){var l;if(f._c){if(!(f._used.indexOf(c)>-1))return;l=c}else l="*";var d=i({value:s[e],getValue:function(){return r.getEffect(a,e)}},n||{});o&&(d.getProp=function(){return o.effectData(e)},d.clearProp=function(){return o.clearEffectData(e)},d.mergeProp=function(e){return H(d.getProp(),[e])},d.id=o.id),r.bus.$emit("p:".concat(e,":").concat(l,":").concat(f.input?1:0),t,[d,a,r.api])}})}}})}($e);var xe={name:"fcFragment",functional:!0,props:["vnode"],render:function(e,t){return t.props.vnode?t.props.vnode:t.children}};function Ce(){var n={};function r(e){e&&this.setVm(e)}return h(r.prototype,{setVm:function(e){this.vm=e,this.$h=e.$createElement},make:function(t,n,r){return e.config.isReservedTag(t)&&n.nativeOn&&delete n.nativeOn,this.makeComponent(t,n,r)},makeComponent:function(e,t,n){var r,i=this.$h(e,(r=t,_.String(r)?{domProps:{innerHTML:r}}:r),n||[]);return i.context=this.vm,i},aliasMap:n}),h(r,{aliasMap:n,alias:function(e,t){n[e]=t},use:function(e){Object.keys(e).forEach(function(n){var i,o=ae(n),a=(i=n,null==i?"":"object"===t(i)?JSON.stringify(i,null,2):String(i)).toLocaleLowerCase(),u=e[n];[n,o,a].forEach(function(e){r.alias(n,u),r.prototype[e]=function(e,t){return this.make(u,e,t)}})})}}),r}function je(e){var t=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(n,Ee);var t=c(n);function n(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.apply(this,arguments)}return n}();return Object.assign(t.prototype,e),t}function Ee(e){h(this,{$handle:e,vm:e.vm,options:{},ref:"fcForm",mergeOptionsRule:{normal:["form","row","info","submitBtn","resetBtn"]}}),this.updateKey(),this.init()}h(Ee.prototype,{__init:function(){var e=this;this.$render=this.$handle.$render,this.$r=function(){var t;return(t=e.$render).renderRule.apply(t,arguments)}},updateKey:function(){this.key=ce()},init:function(){},update:function(){},beforeRender:function(){},form:function(){return this.vm.$refs[this.ref]},getSlot:function(e){return function t(n){if(n){var r=n.$scopedSlots[e];return r||t(n.$pfc)}}(this.vm)},mergeOptions:function(e,t){var n=this;return C(e.map(function(e){return n.tidyOptions(e)}),t,this.mergeOptionsRule)},updateOptions:function(e){this.options=this.mergeOptions([e],this.getDefaultOptions()),this.update()},tidyOptions:function(e){return e},tidyRule:function(e){},mergeProp:function(e){},getDefaultOptions:function(){return{}},render:function(e){}});var Se={name:"componentValidate",load:function(e,t,n){var r=e.getValue();r?e.getProp().validate=[{validator:function(){var i=X(t);if(i){for(var o=arguments.length,a=new Array(o),u=0;u<o;u++)a[u]=arguments[u];return n.exec.apply(n,[i.id,!0===r?"formCreateValidate":r].concat(a,[{attr:e,rule:t,api:n}]))}}}]:(e.clearProp(),n.clearValidateState([t.field]))},watch:function(){Se.load.apply(Se,arguments)}},we={name:"required",load:function(e,n,r){var o=function(e){return _.Boolean(e)?{required:e}:_.String(e)?{message:e}:_.Undef(e)?{required:!1}:_.Function(e)?{validator:e}:_.Object(e)?e:{}}(e.getValue());if(!1===o.required)e.clearProp();else{var a=i({required:!0,validator:function(e,t,n){_.empty(t)?n(a.message):n()}},o);if(!a.message){var u=n.title||"";a.message=(("object"===t(u)?u.title:u)||"")+"不能为空"}e.getProp().validate=[a]}r.sync(n)},watch:function(){we.load.apply(we,arguments)}};var Fe={fetch:function(e){function t(t,n,r){var o=t.value,a=function(e){void 0===e?(t.clearProp(),r.sync(n)):fe(t.getProp(),o.to||"options",e)};if(_.Function(o)&&(o=o(n,r)),(o=function(e){return _.String(e)&&(e={action:e,to:"options"}),e}(o))&&o.action){o.to||(o.to="options");var u=o.onError,c=function(){if(!t.getValue())return t.clearProp(),r.sync(n),!0},f=i(i({headers:{}},o),{},{onSuccess:function(e,t){if(!c()){var i=function(e){return t?e:e.data};_.Function(o.parse)?i=o.parse:o.parse&&_.String(o.parse)&&(i=function(e){return o.parse.split(".").forEach(function(t){e&&(e=e[t])}),e}),a(i(e,n,r)),r.sync(n)}},onError:function(e){a(void 0),c()||(u||function(e){return k(e.message||"fetch fail "+o.action)})(e,n,r)}});e.options.beforeFetch&&G(function(){return e.options.beforeFetch(f,{rule:n,api:r})}),_.Function(o.action)?o.action(n,r).then(function(e){f.onSuccess(e,!0)}).catch(function(e){f.onError(e)}):G(function(){return e.create.fetch(f,{inject:t,rule:n,api:r})})}else a(void 0)}return{name:"fetch",loaded:function(){t.apply(void 0,arguments)},watch:function(){t.apply(void 0,arguments)}}},loadData:function(e){var t={name:"loadData",_fn:[],created:function(t,n,r){this.deleted(t);var i=v(t.getValue()),o=[];i.forEach(function(i){if(i){var a=function o(){!1!==i.watch&&(e.bus.$off("p.loadData."+i.attr,o),e.bus.$once("p.loadData."+i.attr,o));var a=void 0;i.attr&&(a=e.loadData[i.attr]||i.default,i.copy&&(a=A(a))),fe(t.getProp(),i.to||"options",a),r.sync(n)};o.push(function(){return e.bus.$off("p.loadData."+i.attr,a)}),a()}}),this._fn[t.id]=o},deleted:function(e){this._fn[e.id]&&(this._fn[e.id].forEach(function(e){e()}),delete this._fn[e.id]),e.clearProp()}};return t.watch=t.created,t},required:we,componentValidate:Se},ke={name:"html",loadChildren:!1,render:function(e,t){return t.prop.domProps||(t.prop.domProps={}),t.prop.domProps.innerHTML=e,t.vNode.make(t.prop.props.tag||"div",t.prop)},renderChildren:function(e){return Array.isArray(e.rule.children)?e.rule.children.filter(function(e){return _.String(e)}).join(""):""}},Re="undefined"!=typeof window&&window.Vue?window.Vue:e;function Ae(){return function(e,t){var n;return 2===arguments.length?t=(n=arguments[1])[e]:n=arguments[2],{id:t,prop:n}}.apply(void 0,["name"].concat(Array.prototype.slice.call(arguments)))}function Ve(e){return e&&e.el?_.Element(e.el)?e.el:document.querySelector(e.el):window.document.body}function Pe(e,t){var n=new Re({data:function(){return{rule:e,option:t||{}}},render:function(e){return e("FormCreate",{ref:"fc",props:this.$data})}});return n.$mount(),n}var De=1,Te={};export default function e(t){var r,o,a,u,c=n({},xe.name,xe),s={},l={},d=i({},Fe),p=ne(),v={global:{}},m={},y=Ce();function $(e){var t=Te[e];return Array.isArray(t)?t.map(function(e){return e.api()}):t?t.api():void 0}function b(){var e=Ae.apply(void 0,arguments);e.id&&e.prop&&(l[e.id]=e.prop)}function O(){var e=Ae.apply(void 0,arguments);e.id&&e.prop&&(d[e.id]=i(i({},e.prop),{},{name:e.id}))}function x(e){y.use(e)}function C(){var e=Ae.apply(void 0,arguments);if(!e.id||!e.prop)return ge;var t=ie(e.id),n=e.prop,r=!0===n.merge?s[t]:void 0;s[t]=n,Object.setPrototypeOf(n,r||ge),p[t]=Q(t),n.maker&&h(p,n.maker)}function j(e,t){var n;if(_.String(e)){if(n=ie(e),["form-create","formcreate"].indexOf(n)>-1)return V();if(void 0===t)return c[n]}else n=ie(e.name),t=e;n&&t&&(c[n]=t,delete y.aliasMap[n],delete s[n],t.formCreateParser&&C(n,t.formCreateParser))}function F(e){Object.keys(Te).forEach(function(t){(Array.isArray(Te[t])?Te[t]:[Te[t]]).forEach(function(t){t.bus.$emit("p.loadData."+e)})})}function k(e,t){m[e]=t,F(e)}function R(e){delete m[e],F(e)}function V(){return Re.extend(g(L))}function P(){return Re.extend(xe)}function D(e,t){return _.Function(e.install)?e.install(T,t):_.Function(e)&&e(T,t),this}function T(e,t,n){var r=Pe(e,t||{}),i=r.$refs.fc.formCreate;return i.$parent=n,Ve(i.options).appendChild(r.$el),i.api()}function N(n){var r=i({},t);return n?r.inherit={components:c,parsers:s,directives:l,providers:d,maker:p,loadData:m}:delete r.inherit,e(r)}function L(e){var n=e.$options.propsData.rule;h(this,{id:De++,vm:e,create:T,manager:je(t.manager),parsers:s,providers:d,rules:Array.isArray(n)?n:[],name:e.$options.propsData.name||ce(),inFor:e.$options.propsData.inFor,prop:{components:c,directives:l},loadData:m,CreateNode:y,bus:new Re,unwatch:null,options:{},extendApi:t.extendApi||function(e){return e}}),this.init(),this.initOptions(),this.name&&(this.inFor?(Te[this.name]||(Te[this.name]=[]),Te[this.name].push(this)):Te[this.name]=this)}function U(e){h(e,{version:t.version,ui:t.ui,setData:k,removeData:R,maker:p,component:j,directive:b,register:O,$vnode:P,parser:C,use:D,factory:N,componentAlias:x,copyRule:J,copyRules:B,fetch:Oe,$form:V,parseFn:M,parseJson:q,toJson:I,getApi:$,init:function(e){var t=Pe(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),n=t.$refs.fc.formCreate;return{mount:function(e){return e&&_.Element(e)&&(n.options.el=e),Ve(n.options).appendChild(t.$el),n.api()},remove:function(){t.$el.parentNode&&t.$el.parentNode.removeChild(t.$el)},destroy:function(){this.remove(),t.$destroy()},$f:n.api()}}})}if(r=t.attrs||{},o=r.key||[],a=r.array||[],u=r.normal||[],E.push.apply(E,f(o)),S.push.apply(S,f(a)),w.push.apply(w,f(u)),Z([].concat(f(o),f(a),f(u))),h(L.prototype,{init:function(){var e=this,t=this.vm,n=new $e(this);this.$handle=n,t.$f=n.api,t.$emit("input",n.api),t.$on("hook:created",function(){e.isSub()&&(e.unwatch=t.$watch(function(){return t.$pfc.option},function(){e.initOptions(),t.$f.refresh()},{deep:!0}),e.initOptions()),e.created(),t.disabled&&t.$f.disabled(!0)}),t.$on("hook:mounted",function(){e.mounted()}),t.$on("hook:beforeDestroy",function(){if(t.destroyed=!0,e.unwatch&&e.unwatch(),n.reloadRule([]),e.name)if(e.inFor){var r=Te[e.name].indexOf(e);Te[e.name].splice(r,1),Te[e.name].length||delete Te[e.name]}else delete Te[e.name]}),t.$on("hook:updated",function(){n.bindNextTick(function(){return e.bus.$emit("next-tick",n.api)})})},isSub:function(){return this.vm.$pfc&&this.vm.extendOption},initOptions:function(){this.options={};var e=i({formData:{},submitBtn:{},resetBtn:{}},A(v));this.isSub()&&this.mergeOptions(this.options,this.vm.$pfc.$f.config||{},!0),e=this.mergeOptions(e,this.vm.$options.propsData.option),this.updateOptions(e)},mergeOptions:function(e,t,n){return t=A(t),n&&["page","onSubmit","mounted","reload","formData","el"].forEach(function(e){delete t[e]}),t.global&&(e.global=function(e,t){return e?(Object.keys(t||{}).forEach(function(n){t[n]&&(e[n]=H(e[n]||{},t[n]))}),e):t}(e.global,t.global),delete t.global),this.$handle.$manager.mergeOptions([t],e),e},updateOptions:function(e){this.mergeOptions(this.options,e),this.$handle.$manager.updateOptions(this.options)},created:function(){this.$handle.init(),this.vm.$emit("created",this.api())},api:function(){return this.$handle.api},render:function(){return this.$handle.render()},mounted:function(){this.$handle.mounted()}}),U(T),h(T,{create:T,install:function(e,t){if(v=i(i({},v),t||{}),!0!==e._installedFormCreate){e._installedFormCreate=!0,Re=e;var n=function(e){return T(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this)};U(n),e.prototype.$formCreate=n,e.component("FormCreate",V()),e.component("FcFragment",P())}}}),y.use({fragment:"fcFragment"}),C(ke),t.install&&T.use(t),t.inherit){var W=t.inherit;W.components&&h(c,W.components),W.parsers&&h(s,W.parsers),W.directives&&h(l,W.directives),W.providers&&h(d,W.providers),W.maker&&h(p,W.maker),W.loadData&&h(m,W.loadData)}return T}export{z as Creator,Ee as Manager,J as copyRule,B as copyRules,Q as creatorFactory,xe as fragment,H as mergeRule,q as parseJson,I as toJson};
//# sourceMappingURL=index.min.js.map
